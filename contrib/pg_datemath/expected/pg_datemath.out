--
-- Test cases for pg_datemath extension
-- Tests datediff function with various dateparts and edge cases
--
CREATE EXTENSION pg_datemath;
--
-- Basic Day Calculations
--
SELECT 'Day difference basic' AS test;
         test         
----------------------
 Day difference basic
(1 row)

SELECT datediff('day', '2024-01-01'::date, '2024-01-15'::date);
 datediff 
----------
       14
(1 row)

SELECT 'Day difference negative' AS test;
          test           
-------------------------
 Day difference negative
(1 row)

SELECT datediff('day', '2024-01-15'::date, '2024-01-01'::date);
 datediff 
----------
      -14
(1 row)

--
-- Week Calculations
--
SELECT 'Week exact' AS test;
    test    
------------
 Week exact
(1 row)

SELECT datediff('week', '2024-01-01'::date, '2024-01-08'::date);
 datediff 
----------
    1.000
(1 row)

SELECT 'Week partial' AS test;
     test     
--------------
 Week partial
(1 row)

SELECT datediff('week', '2024-01-01'::date, '2024-01-10'::date);
 datediff 
----------
    1.286
(1 row)

--
-- Month Calculations
--
SELECT 'Month aligned' AS test;
     test      
---------------
 Month aligned
(1 row)

SELECT datediff('month', '2024-01-15'::date, '2024-02-15'::date);
 datediff 
----------
    1.000
(1 row)

SELECT 'Month partial' AS test;
     test      
---------------
 Month partial
(1 row)

SELECT datediff('month', '2024-01-15'::date, '2024-02-20'::date);
 datediff 
----------
    1.172
(1 row)

SELECT 'Month end-of-month alignment' AS test;
             test             
------------------------------
 Month end-of-month alignment
(1 row)

SELECT datediff('month', '2024-01-31'::date, '2024-02-29'::date);
 datediff 
----------
    1.000
(1 row)

--
-- Quarter Calculations
--
SELECT 'Quarter aligned' AS test;
      test       
-----------------
 Quarter aligned
(1 row)

SELECT datediff('quarter', '2024-01-01'::date, '2024-04-01'::date);
 datediff 
----------
    1.000
(1 row)

SELECT 'Quarter partial' AS test;
      test       
-----------------
 Quarter partial
(1 row)

SELECT datediff('quarter', '2024-01-15'::date, '2024-05-20'::date);
 datediff 
----------
    1.385
(1 row)

--
-- Year Calculations
--
SELECT 'Year aligned' AS test;
     test     
--------------
 Year aligned
(1 row)

SELECT datediff('year', '2024-03-15'::date, '2025-03-15'::date);
 datediff 
----------
    1.000
(1 row)

SELECT 'Year partial leap year' AS test;
          test          
------------------------
 Year partial leap year
(1 row)

SELECT datediff('year', '2024-01-01'::date, '2024-07-01'::date);
 datediff 
----------
    0.497
(1 row)

--
-- NULL Handling - STRICT functions return NULL for NULL inputs
--
SELECT 'NULL start date' AS test;
      test       
-----------------
 NULL start date
(1 row)

SELECT datediff('day', NULL::date, '2024-01-15'::date);
 datediff 
----------
         
(1 row)

SELECT 'NULL end date' AS test;
     test      
---------------
 NULL end date
(1 row)

SELECT datediff('day', '2024-01-01'::date, NULL::date);
 datediff 
----------
         
(1 row)

--
-- Invalid Datepart
--
SELECT 'Invalid datepart' AS test;
       test       
------------------
 Invalid datepart
(1 row)

SELECT datediff('hour', '2024-01-01'::date, '2024-01-02'::date);
ERROR:  Invalid datepart: 'hour'
HINT:  Valid options: year, quarter, month, week, day
--
-- Case Insensitivity
--
SELECT 'Case insensitive datepart' AS test;
           test            
---------------------------
 Case insensitive datepart
(1 row)

SELECT datediff('MONTH', '2024-01-01'::date, '2024-02-01'::date);
 datediff 
----------
    1.000
(1 row)

SELECT datediff('Month', '2024-01-01'::date, '2024-02-01'::date);
 datediff 
----------
    1.000
(1 row)

SELECT datediff('month', '2024-01-01'::date, '2024-02-01'::date);
 datediff 
----------
    1.000
(1 row)

--
-- Edge Cases
--
SELECT 'Same date' AS test;
   test    
-----------
 Same date
(1 row)

SELECT datediff('day', '2024-01-01'::date, '2024-01-01'::date);
 datediff 
----------
        0
(1 row)

SELECT 'Leap year February 29' AS test;
         test          
-----------------------
 Leap year February 29
(1 row)

SELECT datediff('day', '2024-02-28'::date, '2024-03-01'::date);
 datediff 
----------
        2
(1 row)

SELECT 'Non-leap year February' AS test;
          test          
------------------------
 Non-leap year February
(1 row)

SELECT datediff('day', '2023-02-28'::date, '2023-03-01'::date);
 datediff 
----------
        1
(1 row)

SELECT 'Year boundary' AS test;
     test      
---------------
 Year boundary
(1 row)

SELECT datediff('year', '2024-12-31'::date, '2025-01-01'::date);
 datediff 
----------
    0.003
(1 row)

SELECT 'Multi-year span' AS test;
      test       
-----------------
 Multi-year span
(1 row)

SELECT datediff('year', '2020-01-01'::date, '2025-01-01'::date);
 datediff 
----------
    5.000
(1 row)

SELECT 'Century boundary' AS test;
       test       
------------------
 Century boundary
(1 row)

SELECT datediff('day', '1999-12-31'::date, '2000-01-01'::date);
 datediff 
----------
        1
(1 row)

--
-- Alias Tests
--
SELECT 'Alias: yy for year' AS test;
        test        
--------------------
 Alias: yy for year
(1 row)

SELECT datediff('yy', '2024-01-01'::date, '2025-01-01'::date);
 datediff 
----------
    1.000
(1 row)

SELECT 'Alias: yyyy for year' AS test;
         test         
----------------------
 Alias: yyyy for year
(1 row)

SELECT datediff('yyyy', '2024-01-01'::date, '2025-01-01'::date);
 datediff 
----------
    1.000
(1 row)

SELECT 'Alias: mm for month' AS test;
        test         
---------------------
 Alias: mm for month
(1 row)

SELECT datediff('mm', '2024-01-15'::date, '2024-02-15'::date);
 datediff 
----------
    1.000
(1 row)

SELECT 'Alias: qq for quarter' AS test;
         test          
-----------------------
 Alias: qq for quarter
(1 row)

SELECT datediff('qq', '2024-01-01'::date, '2024-04-01'::date);
 datediff 
----------
    1.000
(1 row)

SELECT 'Alias: wk for week' AS test;
        test        
--------------------
 Alias: wk for week
(1 row)

SELECT datediff('wk', '2024-01-01'::date, '2024-01-08'::date);
 datediff 
----------
    1.000
(1 row)

SELECT 'Alias: dd for day' AS test;
       test        
-------------------
 Alias: dd for day
(1 row)

SELECT datediff('dd', '2024-01-01'::date, '2024-01-15'::date);
 datediff 
----------
       14
(1 row)

--
-- Timestamp Tests
--
SELECT 'Timestamp: basic day diff' AS test;
           test            
---------------------------
 Timestamp: basic day diff
(1 row)

SELECT datediff('day', '2024-01-01 10:30:00'::timestamp, '2024-01-15 14:45:00'::timestamp);
 datediff 
----------
       14
(1 row)

SELECT 'Timestamp: month diff' AS test;
         test          
-----------------------
 Timestamp: month diff
(1 row)

SELECT datediff('month', '2024-01-15 08:00:00'::timestamp, '2024-02-20 16:00:00'::timestamp);
 datediff 
----------
    1.172
(1 row)

--
-- Timestamptz Tests
--
SELECT 'Timestamptz: basic day diff' AS test;
            test             
-----------------------------
 Timestamptz: basic day diff
(1 row)

SELECT datediff('day', '2024-01-01 10:30:00+00'::timestamptz, '2024-01-15 14:45:00+00'::timestamptz);
 datediff 
----------
       14
(1 row)

--
-- Additional Month Calculation Tests
--
SELECT 'Month: Jan 25 to Mar 10' AS test;
          test           
-------------------------
 Month: Jan 25 to Mar 10
(1 row)

SELECT datediff('month', '2024-01-25'::date, '2024-03-10'::date);
 datediff 
----------
    1.483
(1 row)

SELECT 'Month: subscription proration example' AS test;
                 test                  
---------------------------------------
 Month: subscription proration example
(1 row)

SELECT datediff('month', '2024-01-15'::date, '2024-02-20'::date);
 datediff 
----------
    1.172
(1 row)

--
-- Additional Quarter Calculation Tests
--
SELECT 'Quarter: Q1 to Q2 partial' AS test;
           test            
---------------------------
 Quarter: Q1 to Q2 partial
(1 row)

SELECT datediff('quarter', '2024-01-15'::date, '2024-05-20'::date);
 datediff 
----------
    1.385
(1 row)

--
-- Additional Year Calculation Tests
--
SELECT 'Year: partial year calculation' AS test;
              test              
--------------------------------
 Year: partial year calculation
(1 row)

SELECT datediff('year', '2024-03-15'::date, '2025-06-20'::date);
 datediff 
----------
    1.266
(1 row)

SELECT 'Year: exact 5-year tenure' AS test;
           test            
---------------------------
 Year: exact 5-year tenure
(1 row)

SELECT datediff('year', '2020-03-15'::date, '2025-03-15'::date);
 datediff 
----------
    5.000
(1 row)

SELECT 'Year: leap year partial (182 days / 366)' AS test;
                   test                   
------------------------------------------
 Year: leap year partial (182 days / 366)
(1 row)

SELECT datediff('year', '2024-01-01'::date, '2024-07-01'::date);
 datediff 
----------
    0.497
(1 row)

--
-- Week Calculation Additional Tests
--
SELECT 'Week: exact 2 weeks' AS test;
        test         
---------------------
 Week: exact 2 weeks
(1 row)

SELECT datediff('week', '2024-01-01'::date, '2024-01-15'::date);
 datediff 
----------
    2.000
(1 row)

SELECT 'Week: 9 days example' AS test;
         test         
----------------------
 Week: 9 days example
(1 row)

SELECT datediff('week', '2024-01-01'::date, '2024-01-10'::date);
 datediff 
----------
    1.286
(1 row)

DROP EXTENSION pg_datemath;
